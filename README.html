<h1>Simple Administration for MySQL Replication</h1>
<p>This <em>repctl</em> package is a Thor script for developers to setup and administer multiple MySQL servers on a single machine.  Replication may be set up between a master and slave with a single command. Similarly, a new slave may be added to an existing master (that may already have data) with a single command.  A load-generator/benchmark program may be run, and replication status, including current lag, can be seen in a continuously updated display.</p>
<p>The available commands may be seen by running <code>thor list</code>:</p>
<pre>
	<code>
		tethys:repctl mbs$ thor list
		mysql
		-----
		thor mysql:change_master MASTER SLAVE FILE POSITION  # Execute CHANGE MASTER TO on the SLAVE.
		thor mysql:cluster_user INSTANCE                     # Create the cluster user account on a MySQL instance.
		thor mysql:config INSTANCE                           # Initialize the data directory for a new instance.
		thor mysql:config_all                                # Initialize the data directories for all instances.
		thor mysql:crash INSTANCE                            # Crash a running MySQL server.
		thor mysql:dump INSTANCE [DUMPFILE]                  # Dump all databases after FLUSH TABLES WITH READ LOCK
		thor mysql:repl_user INSTANCE                        # Create the replication user account on a MySQL insta...
		thor mysql:reset INSTANCE                            # Remove database and restart MySQL server.
		thor mysql:reset_all                                 # Remove all databases and restart MySQL instances.
		thor mysql:restore INSTANCE [DUMPFILE]               # Restore INSTANCE from a 'mysqldump' file DUMPFILE.
		thor mysql:start_slave SLAVE                         # Issue START SLAVE on the SLAVE MySQL instance.
		thor mysql:status                                    # Show the status of replication.
		thor mysql:stop INSTANCE                             # Stop a running MySQL server instance.
		thor mysql:stop_all                                  # Stop all the MySQL servers.

		setup
		-----
		thor setup:add_slave MASTER SLAVE  # Master has some data that is used to initialize the slave.
		thor setup:repl_pair MASTER SLAVE  # Set up a single master/slave replication pair from the very beginning.

		utils
		-----
		thor utils:bench [INSTANCE] [PROPS]                  # Run the Tungsten Bristlecone benchmarker. The INSTAN...
		thor utils:create_db [INSTANCE] [DBNAME]             #  "Create a database on a MySQL instance. INSTANCE de...
		thor utils:create_tbl [INSTANCE] [DBNAME] [TBLNAME]  #  Create a database table. INSTANCE defaults to DEFAU...
		thor utils:gen_rows [INSTANCE], [DBNAME], [TBLNAME]  #  Add rows to a table that was created by "utils:crea...
		
	</code>
</pre>
<p>Once this tool itself is configured and the prerequisites, described below, are satisfied, a new master/slave pair can be started from scratch with: <code>thor setup:repl_pair 1 2_</code>.  This command stops MySQL instances 1 and 2 if they are running, commpletely removes their data directories, reinitializes the the data directories, restarts the MySQL servers, configures <em>cluster\_user</em> and <em>repl\_user</em> accounts, and starts up replication.  This is perfect for development or test environments where a new clean environment needs to be set up between tests. The MySQL servers will be available on sockets <code>/tmp/mysql1.sock</code> and <code>/tmp/mysql2.sock</code>.</p>
<p>It is reasonable to run six MySQL servers on a MacBook Pro with decent performance.</p>
<h3>Prerequisites and Configuration</h3>
<p>You should have an valid MySQL installation and the Thor gem installed.  Your existing MySQL server will not be affected by the <em>repctl</em> script.  However, binaries from this installation will be reused.  In the <code>config.rb</code> file set the constants:</p>
<ul>
	<li>MYSQL_HOME &#8212; the location of the local MySQL installation</li>
	<li>DATA_HOME &#8212; the location of the directory where per-MySQL server data directories are created.</li>
	<li>DUMP_DIR &#8212; the location where you want dump files to be stored</li>
	<li>RELAY_LOG &#8212; adjust this according to your hostname</li>
</ul>
<p>Next, define the potential instances you want to create.  Edit the <code>servers.yml</code> file as appropriate.</p>
<p>Finally, edit the existing <code>my*.cnf*</code> files to at least have the correct <code>datadir</code> defined.</p>
<h3>Usage</h3>
<p>You are now ready to rock.  Run <code>thor mysql:start_all</code> to start up all the servers listed in your <code>servers.yml</code> file. Instead or subsequently, you can run <code>thor setup:repl_pair 1 2</code> to reset everything and create a master/slave replication pair. Start up some load to the MySQL master (at socket <code>/tmp/mysql1.sock</code>, by default), then watch the replication status change by running <code>thor mysql:status -s 1 2 -c 5</code> to see a continuous update of the status, updated every 5 seconds.  Add a new slave using instance 3, which may or may not be running and may or may not have its data directory initialized, by running <code>thor setup:add_slave 1 3</code>.  This does a dump on the master and a restore on the slave and restarts replication using the proper replication coordinates.</p>
